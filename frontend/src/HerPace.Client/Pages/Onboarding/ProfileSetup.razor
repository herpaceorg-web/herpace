@page "/onboarding/profile"
@using HerPace.Client.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.JSInterop
@inject ApiClient ApiClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Create Your Profile - HerPace</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            Create Your Runner Profile
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
            Tell us about your fitness level and menstrual cycle to create a personalized training plan
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" aria-live="assertive">
                @_errorMessage
            </MudAlert>
        }

        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <MudText Typo="Typo.h6" Class="mb-4">Personal Information</MudText>

            <MudTextField @bind-Value="_model.Name"
                          For="@(() => _model.Name)"
                          Label="Name"
                          Variant="Variant.Outlined"
                          Required="true"
                          Class="mb-4"
                          aria-label="Your name"
                          aria-required="true" />

            <MudDatePicker @bind-Date="_model.DateOfBirth"
                           Label="Date of Birth"
                           Variant="Variant.Outlined"
                           Class="mb-4"
                           aria-label="Date of birth"
                           HelperText="Optional - used for age grading" />

            <MudDivider Class="my-6" />

            <MudText Typo="Typo.h6" Class="mb-4">Fitness Information</MudText>

            <MudSelect T="int"
                       @bind-Value="_model.FitnessLevel"
                       Label="Fitness Level"
                       Variant="Variant.Outlined"
                       Required="true"
                       Class="mb-4"
                       aria-label="Fitness level"
                       aria-required="true">
                <MudSelectItem T="int" Value="0">Beginner - New to running</MudSelectItem>
                <MudSelectItem T="int" Value="1">Intermediate - Regular runner</MudSelectItem>
                <MudSelectItem T="int" Value="2">Advanced - Experienced runner</MudSelectItem>
                <MudSelectItem T="int" Value="3">Elite - Competitive athlete</MudSelectItem>
            </MudSelect>

            <MudNumericField @bind-Value="_model.TypicalWeeklyMileage"
                             Label="Typical Weekly Mileage"
                             Variant="Variant.Outlined"
                             Min="0"
                             Class="mb-4"
                             aria-label="Typical weekly mileage"
                             HelperText="Average km/miles per week (optional)" />

            <MudSelect T="int"
                       @bind-Value="_model.DistanceUnit"
                       Label="Distance Unit"
                       Variant="Variant.Outlined"
                       Required="true"
                       Class="mb-4"
                       aria-label="Distance unit preference">
                <MudSelectItem T="int" Value="0">Kilometers</MudSelectItem>
                <MudSelectItem T="int" Value="1">Miles</MudSelectItem>
            </MudSelect>

            <MudText Typo="Typo.subtitle2" Class="mb-2">Personal Records (Optional)</MudText>
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.FiveKPRString"
                                  Label="5K PR (mm:ss)"
                                  Variant="Variant.Outlined"
                                  Placeholder="25:30"
                                  Class="mb-4"
                                  aria-label="5K personal record" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.TenKPRString"
                                  Label="10K PR (mm:ss)"
                                  Variant="Variant.Outlined"
                                  Placeholder="52:15"
                                  Class="mb-4"
                                  aria-label="10K personal record" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.HalfMarathonPRString"
                                  Label="Half Marathon PR (h:mm:ss)"
                                  Variant="Variant.Outlined"
                                  Placeholder="1:55:30"
                                  Class="mb-4"
                                  aria-label="Half marathon personal record" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_model.MarathonPRString"
                                  Label="Marathon PR (h:mm:ss)"
                                  Variant="Variant.Outlined"
                                  Placeholder="4:15:00"
                                  Class="mb-4"
                                  aria-label="Marathon personal record" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-6" />

            <MudText Typo="Typo.h6" Class="mb-2">Menstrual Cycle Information</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                This helps us create a plan that adapts to your hormone fluctuations throughout your cycle
            </MudText>

            <MudNumericField @bind-Value="_model.CycleLength"
                             For="@(() => _model.CycleLength)"
                             Label="Cycle Length (days)"
                             Variant="Variant.Outlined"
                             Min="21"
                             Max="45"
                             Class="mb-4"
                             aria-label="Cycle length in days"
                             aria-required="true"
                             HelperText="Typical cycle length (21-45 days)" />

            <MudDatePicker @bind-Date="_model.LastPeriodStart"
                           Label="Last Period Start Date"
                           Variant="Variant.Outlined"
                           MaxDate="DateTime.Today"
                           Class="mb-4"
                           aria-label="Last period start date"
                           HelperText="When did your last period start?" />

            <MudSelect T="int"
                       @bind-Value="_model.TypicalCycleRegularity"
                       Label="Cycle Regularity"
                       Variant="Variant.Outlined"
                       Required="true"
                       Class="mb-6"
                       aria-label="Cycle regularity">
                <MudSelectItem T="int" Value="0">Regular - Predictable cycle</MudSelectItem>
                <MudSelectItem T="int" Value="1">Irregular - Varies by 7+ days</MudSelectItem>
                <MudSelectItem T="int" Value="2">Do Not Track - Skip cycle awareness</MudSelectItem>
            </MudSelect>

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       Disabled="@_isLoading"
                       aria-label="Continue to race entry">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <span>Saving Profile...</span>
                }
                else
                {
                    <span>Continue</span>
                }
            </MudButton>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private ProfileModel _model = new();
    private bool _isLoading = false;
    private string _errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Load auth token from localStorage and set it on ApiClient
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
        if (!string.IsNullOrEmpty(token))
        {
            ApiClient.SetAuthToken(token);
        }
        else
        {
            // No token found, redirect to login
            Navigation.NavigateTo("/login");
        }
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            // Parse PR strings to TimeSpan
            var request = new CreateProfileRequest
            {
                Name = _model.Name,
                DateOfBirth = _model.DateOfBirth,
                FitnessLevel = _model.FitnessLevel,
                TypicalWeeklyMileage = _model.TypicalWeeklyMileage,
                DistanceUnit = _model.DistanceUnit,
                FiveKPR = ParseTimeString(_model.FiveKPRString),
                TenKPR = ParseTimeString(_model.TenKPRString),
                HalfMarathonPR = ParseTimeString(_model.HalfMarathonPRString),
                MarathonPR = ParseTimeString(_model.MarathonPRString),
                CycleLength = _model.CycleLength,
                LastPeriodStart = _model.LastPeriodStart,
                TypicalCycleRegularity = _model.TypicalCycleRegularity
            };

            var response = await ApiClient.PostAsync<CreateProfileRequest, ProfileResponse>(
                "/api/profiles/me",
                request);

            if (response != null)
            {
                // Navigate to race entry
                Navigation.NavigateTo("/onboarding/race");
            }
            else
            {
                _errorMessage = "Failed to create profile. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private TimeSpan? ParseTimeString(string? input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return null;

        try
        {
            // Try parsing formats: mm:ss or h:mm:ss
            var parts = input.Split(':');
            if (parts.Length == 2)
            {
                return new TimeSpan(0, int.Parse(parts[0]), int.Parse(parts[1]));
            }
            else if (parts.Length == 3)
            {
                return new TimeSpan(int.Parse(parts[0]), int.Parse(parts[1]), int.Parse(parts[2]));
            }
        }
        catch
        {
            // Invalid format, return null
        }

        return null;
    }

    private class ProfileModel
    {
        [Required]
        public string Name { get; set; } = string.Empty;
        public DateTime? DateOfBirth { get; set; }

        public int FitnessLevel { get; set; } = 0;
        public decimal? TypicalWeeklyMileage { get; set; }
        public int DistanceUnit { get; set; } = 0;

        public string? FiveKPRString { get; set; }
        public string? TenKPRString { get; set; }
        public string? HalfMarathonPRString { get; set; }
        public string? MarathonPRString { get; set; }

        [Range(21, 45, ErrorMessage = "Cycle length must be between 21 and 45 days")]
        public int? CycleLength { get; set; }
        public DateTime? LastPeriodStart { get; set; }
        public int TypicalCycleRegularity { get; set; } = 0;
    }

    private class CreateProfileRequest
    {
        public string Name { get; set; } = string.Empty;
        public DateTime? DateOfBirth { get; set; }
        public int FitnessLevel { get; set; }
        public decimal? TypicalWeeklyMileage { get; set; }
        public int DistanceUnit { get; set; }
        public TimeSpan? FiveKPR { get; set; }
        public TimeSpan? TenKPR { get; set; }
        public TimeSpan? HalfMarathonPR { get; set; }
        public TimeSpan? MarathonPR { get; set; }
        public int? CycleLength { get; set; }
        public DateTime? LastPeriodStart { get; set; }
        public int TypicalCycleRegularity { get; set; }
    }

    private class ProfileResponse
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }
}
