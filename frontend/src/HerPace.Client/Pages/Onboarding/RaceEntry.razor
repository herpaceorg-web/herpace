@page "/onboarding/race"
@using HerPace.Client.Services
@using System.ComponentModel.DataAnnotations
@using Microsoft.JSInterop
@inject ApiClient ApiClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Enter Your Race Goal - HerPace</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h4" GutterBottom="true">
            Enter Your Race Goal
        </MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-6">
            Tell us about the race you're training for, and we'll create a personalized plan
        </MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" aria-live="assertive">
                @_errorMessage
            </MudAlert>
        }

        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <MudTextField @bind-Value="_model.RaceName"
                          For="@(() => _model.RaceName)"
                          Label="Race Name"
                          Variant="Variant.Outlined"
                          Required="true"
                          Class="mb-4"
                          aria-label="Race name"
                          aria-required="true"
                          Placeholder="e.g., Boston Marathon 2026" />

            <MudTextField @bind-Value="_model.Location"
                          Label="Location"
                          Variant="Variant.Outlined"
                          Class="mb-4"
                          aria-label="Race location"
                          Placeholder="e.g., Boston, MA (optional)" />

            <MudDatePicker @bind-Date="_model.RaceDate"
                           For="@(() => _model.RaceDate)"
                           Label="Race Date"
                           Variant="Variant.Outlined"
                           Required="true"
                           MinDate="DateTime.Today.AddDays(7)"
                           Class="mb-4"
                           aria-label="Race date"
                           aria-required="true"
                           HelperText="Must be at least 7 days in the future" />

            <MudSelect T="int"
                       @bind-Value="_model.DistanceType"
                       For="@(() => _model.DistanceType)"
                       Label="Race Distance"
                       Variant="Variant.Outlined"
                       Required="true"
                       Class="mb-4"
                       aria-label="Race distance"
                       aria-required="true">
                <MudSelectItem T="int" Value="0">5K (5 kilometers)</MudSelectItem>
                <MudSelectItem T="int" Value="1">10K (10 kilometers)</MudSelectItem>
                <MudSelectItem T="int" Value="2">Half Marathon (21.1 km)</MudSelectItem>
                <MudSelectItem T="int" Value="3">Marathon (42.2 km)</MudSelectItem>
            </MudSelect>

            <MudNumericField @bind-Value="_model.Distance"
                             Label="Custom Distance (km)"
                             Variant="Variant.Outlined"
                             Min="1"
                             Class="mb-4"
                             aria-label="Custom distance"
                             HelperText="Leave blank for standard race distances" />

            <MudTextField @bind-Value="_model.GoalTime"
                          Label="Goal Time (optional)"
                          Variant="Variant.Outlined"
                          Class="mb-4"
                          aria-label="Goal finish time"
                          Placeholder="e.g., 1:45:00 or 4:30:00"
                          HelperText="Your target finish time (h:mm:ss)" />

            <MudTextField @bind-Value="_model.RaceCompletionGoal"
                          Label="Race Completion Goal (optional)"
                          Variant="Variant.Outlined"
                          Lines="3"
                          Class="mb-6"
                          aria-label="Race completion goal"
                          Placeholder="e.g., Complete strong without injury, qualify for Boston"
                          HelperText="What do you want to achieve?" />

            <MudButton ButtonType="ButtonType.Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Size="Size.Large"
                       Disabled="@_isLoading"
                       aria-label="Generate training plan">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <span>Creating Race Goal...</span>
                }
                else
                {
                    <span>Continue to Plan Generation</span>
                }
            </MudButton>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private RaceModel _model = new();
    private bool _isLoading = false;
    private string _errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Load auth token from localStorage and set it on ApiClient
        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
        if (!string.IsNullOrEmpty(token))
        {
            ApiClient.SetAuthToken(token);
        }
        else
        {
            // No token found, redirect to login
            Navigation.NavigateTo("/login");
        }

        // Set default race date to 3 months from now
        _model.RaceDate = DateTime.Today.AddMonths(3);
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            // Calculate distance based on distance type if custom distance not provided
            var distance = _model.Distance ?? GetStandardDistance(_model.DistanceType);

            var request = new CreateRaceRequest
            {
                RaceName = _model.RaceName,
                Location = _model.Location,
                RaceDate = _model.RaceDate!.Value,
                Distance = distance,
                DistanceType = _model.DistanceType,
                GoalTime = _model.GoalTime,
                RaceCompletionGoal = _model.RaceCompletionGoal,
                IsPublic = false
            };

            var raceResponse = await ApiClient.PostAsync<CreateRaceRequest, RaceResponse>(
                "/api/races",
                request);

            if (raceResponse != null)
            {
                // Generate training plan for this race
                var planRequest = new GeneratePlanRequest { RaceId = raceResponse.Id };

                var planResponse = await ApiClient.PostAsync<GeneratePlanRequest, PlanResponse>(
                    "/api/plans",
                    planRequest);

                if (planResponse != null)
                {
                    // Navigate to plan view
                    Navigation.NavigateTo($"/plan/{planResponse.Id}");
                }
                else
                {
                    _errorMessage = "Failed to generate training plan. Please try again.";
                }
            }
            else
            {
                _errorMessage = "Failed to create race goal. Please try again.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private decimal GetStandardDistance(int distanceType)
    {
        return distanceType switch
        {
            0 => 5.0m,      // 5K
            1 => 10.0m,     // 10K
            2 => 21.1m,     // Half Marathon
            3 => 42.2m,     // Marathon
            _ => 10.0m
        };
    }

    private class RaceModel
    {
        [Required]
        public string RaceName { get; set; } = string.Empty;
        public string? Location { get; set; }
        [Required]
        public DateTime? RaceDate { get; set; }
        public int DistanceType { get; set; } = 2; // Default to Half Marathon
        public decimal? Distance { get; set; }
        public string? GoalTime { get; set; }
        public string? RaceCompletionGoal { get; set; }
    }

    private class CreateRaceRequest
    {
        public string RaceName { get; set; } = string.Empty;
        public string? Location { get; set; }
        public DateTime RaceDate { get; set; }
        public decimal Distance { get; set; }
        public int DistanceType { get; set; }
        public string? GoalTime { get; set; }
        public string? RaceCompletionGoal { get; set; }
        public bool IsPublic { get; set; }
    }

    private class RaceResponse
    {
        public Guid Id { get; set; }
        public string RaceName { get; set; } = string.Empty;
    }

    private class GeneratePlanRequest
    {
        public Guid RaceId { get; set; }
    }

    private class PlanResponse
    {
        public Guid Id { get; set; }
        public string PlanName { get; set; } = string.Empty;
    }
}
