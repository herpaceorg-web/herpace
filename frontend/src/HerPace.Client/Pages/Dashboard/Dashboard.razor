@page "/dashboard"
@using HerPace.Client.Components.Session
@using HerPace.Client.Components.Cycle
@using HerPace.Client.Services
@using HerPace.Client.Models
@using System.Text.Json
@using System.Timers
@inject ApiClient ApiClient
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Dashboard - HerPace</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
    @if (loading)
    {
        <div class="d-flex justify-center align-center" style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (planSummary == null)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            <MudText Typo="Typo.h6">No Active Training Plan</MudText>
            <MudText Typo="Typo.body2" Class="mt-2">
                You don't have an active training plan yet. Create one to get started!
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/onboarding/race" Class="mt-3">
                Create Training Plan
            </MudButton>
        </MudAlert>
    }
    else
    {
        @* Testing Mode Badge *@
        @if (Testing)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>Testing Mode Active</strong> - You can modify future sessions for testing purposes.
            </MudAlert>
        }

        @* Race Header *@
        <div class="mb-6">
            <MudText Typo="Typo.h4" Class="mb-2">Welcome Back!</MudText>
            <MudText Typo="Typo.h6" Color="Color.Secondary">
                @planSummary.RaceName - @planSummary.DaysUntilRace days to go
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Race Date: @planSummary.RaceDate.ToString("MMMM dd, yyyy")
            </MudText>
        </div>

        @* Recalculation In Progress *@
        @if (planSummary.HasPendingRecalculation)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                <div class="d-flex align-center">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.body1"><strong>Recalculating your plan...</strong></MudText>
                        <MudText Typo="Typo.body2">We're adjusting your upcoming sessions based on your recent performance.</MudText>
                    </div>
                </div>
            </MudAlert>
        }

        @* Recalculation Summary Alert *@
        @if (!string.IsNullOrEmpty(planSummary.RecalculationSummary))
        {
            <RecalculationAlert Summary="@planSummary.RecalculationSummary" OnDismiss="DismissSummary" />
        }

        <MudGrid>
            @* Cycle Position Card *@
            <MudItem xs="12" md="6" Class="mb-6">
                @if (cyclePosition != null)
                {
                    <CyclePositionCard
                        CyclePosition="@cyclePosition"
                        OnReportPeriodClick="@OpenReportDialog" />
                }
                else
                {
                    <MudPaper Elevation="3" Class="pa-6">
                        <MudText Typo="Typo.h6" GutterBottom="true">Cycle Tracking</MudText>
                        <MudAlert Severity="Severity.Info">
                            Cycle tracking is not enabled. Update your profile to enable cycle-aware training.
                        </MudAlert>
                    </MudPaper>
                }
            </MudItem>

            @* Today's Workout Card *@
            <MudItem xs="12" md="6" Class="mb-6">
                <MudPaper Elevation="3" Class="pa-6">
                    <MudText Typo="Typo.h5" Class="mb-3">Today's Workout</MudText>

                    @if (planSummary.TodaysSession != null)
                    {
                        <SessionCard Session="@planSummary.TodaysSession"
                                     AllowModification="@Testing"
                                     OnCompleteRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenCompleteDialog))"
                                     OnSkipRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenSkipDialog))"
                                     OnReportWorkoutRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenReportWorkoutDialog))"
                                     OnModifyRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenModifyDialog))" />
                    }
                    else
                    {
                        <MudPaper Class="pa-4" Elevation="0">
                            <MudText Typo="Typo.body1" Color="Color.Secondary">
                                No session scheduled for today - rest day!
                            </MudText>
                        </MudPaper>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>

        @* Upcoming Sessions *@
        <div class="mb-6">
            <div class="d-flex justify-space-between align-center mb-3">
                <MudText Typo="Typo.h5">Upcoming This Week</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/plan" EndIcon="@Icons.Material.Filled.ArrowForward">
                    View Full Plan
                </MudButton>
            </div>

            @if (upcomingSessions.Any())
            {
                @foreach (var session in upcomingSessions)
                {
                    <SessionCard Session="@session"
                                 AllowModification="@Testing"
                                 OnCompleteRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenCompleteDialog))"
                                 OnSkipRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenSkipDialog))"
                                 OnReportWorkoutRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenReportWorkoutDialog))"
                                 OnModifyRequested="@(EventCallback.Factory.Create<SessionCard.SessionDetailDto>(this, OpenModifyDialog))" />
                }
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">No upcoming sessions in the next 7 days.</MudText>
            }
        </div>
    }
</MudContainer>

@* Report Period Dialog *@
<ReportPeriodDialog
    @bind-IsOpen="_showReportDialog"
    OnPeriodReported="@HandlePeriodReported" />

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public bool Testing { get; set; } = false;

    private bool loading = true;
    private PlanSummaryDto? planSummary;
    private CyclePositionDto? cyclePosition;
    private List<SessionCard.SessionDetailDto> upcomingSessions = new();
    private System.Timers.Timer? pollingTimer;
    private bool _showReportDialog = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        loading = true;

        try
        {
            // Set auth token
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavigationManager.NavigateTo("/login");
                return;
            }

            ApiClient.SetAuthToken(token);

            // Load plan summary
            planSummary = await ApiClient.GetAsync<PlanSummaryDto>("/api/sessions/plan-summary");

            // Load cycle position
            try
            {
                cyclePosition = await ApiClient.GetAsync<CyclePositionDto>("/api/cycle/position");
            }
            catch
            {
                // Cycle tracking not enabled, this is OK
                cyclePosition = null;
            }

            // Load upcoming sessions
            var upcomingResponse = await ApiClient.GetAsync<UpcomingSessionsResponse>("/api/sessions/upcoming?count=7");
            if (upcomingResponse != null)
            {
                // Filter out today's session from upcoming list
                upcomingSessions = upcomingResponse.Sessions
                    .Where(s => s.ScheduledDate.Date > DateTime.UtcNow.Date)
                    .ToList();
            }

            // Start polling if recalculation is pending
            if (planSummary?.HasPendingRecalculation == true)
            {
                StartPolling();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void StartPolling()
    {
        pollingTimer?.Dispose();
        pollingTimer = new System.Timers.Timer(5000); // Poll every 5 seconds
        pollingTimer.Elapsed += OnPollingTimerElapsed;
        pollingTimer.AutoReset = true;
        pollingTimer.Start();
    }

    private async void OnPollingTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        try
        {
            var updatedSummary = await ApiClient.GetAsync<PlanSummaryDto>("/api/sessions/plan-summary");

            if (updatedSummary != null && !updatedSummary.HasPendingRecalculation)
            {
                // Recalculation complete - stop polling and reload
                StopPolling();
                await InvokeAsync(async () =>
                {
                    await LoadDashboard();
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Polling error: {ex.Message}");
        }
    }

    private void StopPolling()
    {
        pollingTimer?.Stop();
        pollingTimer?.Dispose();
        pollingTimer = null;
    }

    private async Task OpenCompleteDialog(SessionCard.SessionDetailDto session)
    {
        // For rest days, just confirm and complete without asking for details
        if (session.WorkoutType == SessionCard.WorkoutType.Rest)
        {
            var confirm = await DialogService.ShowMessageBox(
                "Rest Day",
                "Great job listening to your body! Mark this rest day as complete?",
                yesText: "Yes",
                cancelText: "Cancel");

            if (confirm == true)
            {
                // Submit rest day completion with minimal data
                var restDayCompletion = new
                {
                    ActualDistance = (decimal?)null,
                    ActualDuration = (int?)null,
                    RPE = (int?)null,
                    UserNotes = "Rest day - took it easy"
                };
                await CompleteSession(session.Id, restDayCompletion);
            }
        }
        else
        {
            var parameters = new DialogParameters
            {
                ["Session"] = session
            };

            var dialog = await DialogService.ShowAsync<SessionCompletionDialog>("Complete Workout", parameters);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data != null)
            {
                await CompleteSession(session.Id, result.Data);
            }
        }
    }

    private async Task OpenSkipDialog(SessionCard.SessionDetailDto session)
    {
        var parameters = new DialogParameters
        {
            ["Session"] = session
        };

        var dialog = await DialogService.ShowAsync<SessionSkipDialog>("Skip Workout", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            await SkipSession(session.Id, result.Data);
        }
    }

    private async Task OpenReportWorkoutDialog(SessionCard.SessionDetailDto session)
    {
        var parameters = new DialogParameters
        {
            ["Session"] = session
        };

        var dialog = await DialogService.ShowAsync<ReportRestDayWorkoutDialog>("Report Workout", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            // Use the complete endpoint to log the workout
            await CompleteSession(session.Id, result.Data);
        }
    }

    private async Task OpenModifyDialog(SessionCard.SessionDetailDto session)
    {
        var parameters = new DialogParameters
        {
            ["Session"] = session
        };

        var dialog = await DialogService.ShowAsync<SessionCompletionDialog>("Modify Workout", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data != null)
        {
            await CompleteSession(session.Id, result.Data);
        }
    }

    private async Task CompleteSession(Guid sessionId, object requestData)
    {
        try
        {
            var response = await ApiClient.PutAsync<object, SessionCompletionResponse>(
                $"/api/sessions/{sessionId}/complete",
                requestData);

            if (response != null && response.Success)
            {
                Snackbar.Add(response.Message ?? "Workout completed!", Severity.Success);

                if (response.RecalculationTriggered)
                {
                    StartPolling();
                }

                await LoadDashboard();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error completing session: {ex.Message}", Severity.Error);
        }
    }

    private async Task SkipSession(Guid sessionId, object requestData)
    {
        try
        {
            var response = await ApiClient.PutAsync<object, SessionCompletionResponse>(
                $"/api/sessions/{sessionId}/skip",
                requestData);

            if (response != null && response.Success)
            {
                Snackbar.Add(response.Message ?? "Workout skipped.", Severity.Info);

                if (response.RecalculationTriggered)
                {
                    StartPolling();
                }

                await LoadDashboard();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error skipping session: {ex.Message}", Severity.Error);
        }
    }

    private async Task DismissSummary()
    {
        try
        {
            await ApiClient.PostAsync<object, object>("/api/sessions/dismiss-summary", new { });
            await LoadDashboard();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error dismissing summary: {ex.Message}", Severity.Error);
        }
    }

    private void OpenReportDialog()
    {
        _showReportDialog = true;
    }

    private async Task HandlePeriodReported(ReportPeriodResponse response)
    {
        _showReportDialog = false;

        if (response.Success)
        {
            Snackbar.Add(response.Message, Severity.Success);

            if (response.TriggeredRegeneration)
            {
                Snackbar.Add("Your training plan is being adjusted based on your cycle update.", Severity.Info);
                StartPolling();
            }

            // Reload dashboard data
            await LoadDashboard();
        }
        else
        {
            Snackbar.Add("Failed to report period. Please try again.", Severity.Error);
        }
    }

    public void Dispose()
    {
        StopPolling();
    }

    // DTOs
    private class PlanSummaryDto
    {
        public Guid PlanId { get; set; }
        public string PlanName { get; set; } = string.Empty;
        public string RaceName { get; set; } = string.Empty;
        public DateTime RaceDate { get; set; }
        public int DaysUntilRace { get; set; }
        public bool HasPendingRecalculation { get; set; }
        public string? RecalculationSummary { get; set; }
        public SessionCard.SessionDetailDto? TodaysSession { get; set; }
    }

    private class UpcomingSessionsResponse
    {
        public List<SessionCard.SessionDetailDto> Sessions { get; set; } = new();
        public bool HasPendingRecalculation { get; set; }
    }

    private class SessionCompletionResponse
    {
        public Guid SessionId { get; set; }
        public bool Success { get; set; }
        public bool RecalculationTriggered { get; set; }
        public string? Message { get; set; }
    }
}
