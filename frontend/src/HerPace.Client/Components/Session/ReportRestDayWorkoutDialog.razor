@using MudBlazor
@using static HerPace.Client.Components.Session.SessionCard
@using HerPace.Client.Services
@inject ISnackbar Snackbar
@inject UserPreferencesService UserPreferencesService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.DirectionsRun" Class="mr-2" />
            Report Workout
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.subtitle2" Class="mb-4">@Session.SessionName - @Session.ScheduledDate.ToString("MMM dd, yyyy")</MudText>

        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
            This was scheduled as a rest day. Let's log the workout you did instead!
        </MudAlert>

        <MudNumericField @bind-Value="ActualDistance"
                         Label="@GetDistanceLabel()"
                         Variant="Variant.Outlined"
                         Step="0.1M"
                         Min="0M"
                         Class="mb-4" />

        <MudNumericField @bind-Value="ActualDuration"
                         Label="Duration (minutes)"
                         Variant="Variant.Outlined"
                         Step="1"
                         Min="0"
                         Class="mb-4" />

        <div class="mb-4">
            <MudText Typo="Typo.body2" Class="mb-2">Rate of Perceived Exertion (RPE)</MudText>
            <MudRating @bind-SelectedValue="RPE" MaxValue="10" Size="Size.Large" />
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @GetRPEDescription()
            </MudText>
        </div>

        <MudTextField @bind-Value="UserNotes"
                      Label="Notes (optional)"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="What workout did you do? How did it feel?"
                      Class="mb-2" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!IsValid())">
            Log Workout
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private dynamic? Dialog { get; set; }

    [Parameter]
    public SessionDetailDto Session { get; set; } = null!;

    private decimal? ActualDistance { get; set; }
    private int? ActualDuration { get; set; }
    private int RPE { get; set; } = 5;
    private string? UserNotes { get; set; }
    private DistanceUnit _userDistanceUnit = DistanceUnit.Kilometers;

    protected override async Task OnInitializedAsync()
    {
        // Load user's distance unit preference
        try
        {
            _userDistanceUnit = await UserPreferencesService.GetDistanceUnitAsync();
        }
        catch
        {
            // Default to kilometers if unable to load preference
            _userDistanceUnit = DistanceUnit.Kilometers;
        }
    }

    private string GetRPEDescription()
    {
        return RPE switch
        {
            <= 2 => "Very easy",
            <= 4 => "Easy",
            <= 6 => "Moderate",
            <= 8 => "Hard",
            _ => "Very hard"
        };
    }

    private bool IsValid()
    {
        // At least one of distance or duration must be provided
        return ActualDistance.HasValue || ActualDuration.HasValue;
    }

    private void Cancel()
    {
        Dialog?.Close(DialogResult.Cancel());
    }

    private void Submit()
    {
        // Convert distance to kilometers for storage (API always stores in km)
        var distanceInKm = ActualDistance.HasValue && _userDistanceUnit == DistanceUnit.Miles
            ? DistanceConversionService.MilesToKm(ActualDistance.Value)
            : ActualDistance;

        var completionRequest = new
        {
            ActualDistance = distanceInKm,
            ActualDuration,
            RPE = (int?)RPE,
            UserNotes
        };

        Dialog?.Close(DialogResult.Ok(completionRequest));
    }

    private string GetDistanceLabel()
    {
        var unitLabel = _userDistanceUnit == DistanceUnit.Miles ? "mi" : "km";
        return $"Distance ({unitLabel})";
    }
}
