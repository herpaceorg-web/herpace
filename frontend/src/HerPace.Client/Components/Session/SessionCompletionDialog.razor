@using MudBlazor
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
            Complete Workout
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.subtitle2" Class="mb-4">@Session.SessionName - @Session.ScheduledDate.ToString("MMM dd, yyyy")</MudText>

        <MudNumericField @bind-Value="ActualDistance"
                         Label="Actual Distance (km)"
                         Variant="Variant.Outlined"
                         Step="0.1M"
                         Min="0M"
                         HelperText="@GetDistanceHelper()"
                         Class="mb-4" />

        <MudNumericField @bind-Value="ActualDuration"
                         Label="Actual Duration (minutes)"
                         Variant="Variant.Outlined"
                         Step="1"
                         Min="0"
                         HelperText="@GetDurationHelper()"
                         Class="mb-4" />

        <div class="mb-4">
            <MudText Typo="Typo.body2" Class="mb-2">Rate of Perceived Exertion (RPE)</MudText>
            <MudRating @bind-SelectedValue="RPE" MaxValue="10" Size="Size.Large" />
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @GetRPEDescription()
            </MudText>
        </div>

        <MudTextField @bind-Value="UserNotes"
                      Label="Notes (optional)"
                      Variant="Variant.Outlined"
                      Lines="3"
                      Placeholder="How did the workout feel? Any observations..."
                      Class="mb-2" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Disabled="@(!IsValid())">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private dynamic? Dialog { get; set; }

    [Parameter]
    public SessionDetailDto Session { get; set; } = null!;

    [Parameter]
    public EventCallback<bool> OnCompleted { get; set; }

    private decimal? ActualDistance { get; set; }
    private int? ActualDuration { get; set; }
    private int RPE { get; set; } = 5;
    private string? UserNotes { get; set; }

    protected override void OnInitialized()
    {
        // Pre-fill with planned values
        ActualDistance = Session.Distance;
        ActualDuration = Session.DurationMinutes;
    }

    private string GetDistanceHelper()
    {
        if (Session.Distance.HasValue)
        {
            return $"Planned: {Session.Distance.Value:F1} km";
        }
        return string.Empty;
    }

    private string GetDurationHelper()
    {
        if (Session.DurationMinutes.HasValue)
        {
            return $"Planned: {Session.DurationMinutes.Value} min";
        }
        return string.Empty;
    }

    private string GetRPEDescription()
    {
        return RPE switch
        {
            <= 2 => "Very easy",
            <= 4 => "Easy",
            <= 6 => "Moderate",
            <= 8 => "Hard",
            _ => "Very hard"
        };
    }

    private bool IsValid()
    {
        // At least one of distance or duration must be provided
        return ActualDistance.HasValue || ActualDuration.HasValue;
    }

    private void Cancel()
    {
        Dialog?.Cancel();
    }

    private void Submit()
    {
        var completionRequest = new
        {
            ActualDistance,
            ActualDuration,
            RPE = (int?)RPE,
            UserNotes
        };

        Dialog?.Close(DialogResult.Ok(completionRequest));
    }

    public class SessionDetailDto
    {
        public Guid Id { get; set; }
        public string SessionName { get; set; } = string.Empty;
        public DateTime ScheduledDate { get; set; }
        public int? DurationMinutes { get; set; }
        public decimal? Distance { get; set; }
    }
}
